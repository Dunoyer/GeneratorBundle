{% extends '../CommonAdmin/ListAction/ListBuilderAction.php.twig' %}

{% block getQuery -%}
    protected function getQuery()
    {
        $query = $this->buildQuery();

        $this->processQuery($query);
        $this->processSort($query);
        $this->processFilters($query);
        $this->processScopes($query);

        return $query->getQuery();
    }

    protected function buildQuery()
    {
        return $this->getDoctrine()
                    ->getManagerForClass('{{ model }}')
                    ->getRepository('{{ model }}')
                    ->createQueryBuilder('q');
    }
{% endblock %}

{% block processSort -%}
    protected function processSort($query)
    {
        $virtualGettersMap = array(
        {% for column in builder.columns %}
            {%- if column.dbType == 'virtual' %}
            {{ column.name|as_php }},
            {%- endif %}
        {% endfor %}
        );

        $field = $this->getSortColumn();
        $order = $this->getSortOrder();

        if ($field) {
            $queryFilter = $this->getQueryFilter();
            $queryFilter->setQuery($query);
            $queryFilter->setAliasPrefix('o_');
            $queryFilter->setNamePrefix('order_');

            if (in_array($field, $virtualGettersMap)) {
                $handleSortMethod = 'handle'.$field.'Sort';
                $this->$handleSortMethod($queryFilter, $field, $order);
            } else {
                $queryFilter->sortBy($field, $order);
            }
        }
    }

    {% for column in builder.columns %}
        {%- if column.dbType == 'virtual' %}
    /**
     * Add the sort to the query for {{ column.name }}
     *
     * @param QueryFilterInterface  $queryFilter        The queryFilter.
     * @param string                $field              The field.
     * @param string                $order              The sort order.
     */
    protected function handle{{ column.name|classify }}Sort($queryFilter, $field, $order)
    {
    }
        {%- endif %}
    {% endfor %}

{% endblock %}

{% block processFilters -%}
    protected function processFilters($query)
    {
        $filtersFormData = $this->getFilters();

        $virtualGettersMap = array(
        {% for column in builder.filterColumns -%}
            {%- if column.dbType == 'virtual' %}
            {{ column.name|as_php }},
            {%- endif %}
        {% endfor %}
        );
        
        $filtersMap = array(
        {% for column in builder.filterColumns %}
            {{ column.name|as_php }} => {{ column.filterType|as_php }},
        {% endfor %}
        );

        $primaryKeysMap = array(
        {% for column in builder.filterColumns %}
            {{ column.name|as_php }} => {{ column.primaryKey|as_php }},
        {% endfor %}
        );

        $queryFilter = $this->getQueryFilter();
        $queryFilter->setQuery($query);
        $queryFilter->setAliasPrefix('f_');
        $queryFilter->setNamePrefix('filters_');
        $queryFilter->setFiltersMap($filtersMap);
        $queryFilter->setPrimaryKeysMap($primaryKeysMap);

        $groupParts = array();
        foreach ($filtersFormData as $groupData) {
            $filterParts = array();
            foreach ($groupData as $filterData) {
                $field          = $filterData['field'];
                $operator       = $filterData['operator'];
                $value          = $filterData['value'];

                if (in_array($field, $virtualGettersMap)) {
                    $handleFilterMethod = 'handle'.$field.'Filter';
                    $filterParts[] = $this->$handleFilterMethod($queryFilter, $field, $operator, $value);
                } else {
                    $param = $queryFilter->getUniqueName();
                    $filterParts[] = $queryFilter->getComparison($field, $operator, $param);
                    $query->setParameter($param, $queryFilter->formatValue($field, $operator, $value));
                }
            }
            // for a group to be true, all partial conditions must be true
            $groupParts[] = $queryFilter->getConjunction($filterParts);
        }

        if (count($filtersFormData) > 0) {
            // the results must meet conditions of at least one group
            $query->andWhere($queryFilter->getDisjunction($groupParts));
        }
    }

    {% for column in builder.filterColumns %}
        {%- if column.dbType == 'virtual' %}
    /**
     * Add the filters to the query for {{ column.name }}
     *
     * @param QueryFilterInterface  $queryFilter       The queryFilter.
     * @param string                $field             The field.
     * @param string                $operator          The operator.
     * @param string                $value             The value.
     * @return Doctrine\ORM\Query\Expr\Comparison
     */
    protected function handle{{ column.name|classify }}Filter($queryFilter, $field, $operator, $value)
    {
    }
        {%- endif %}
    {% endfor %}
    
{% endblock %}

{% block processScopes -%}
    protected function processScopes($query)
    {

    {% if scopes is defined %}
        $scopes = $this->getScopes();
        
        $filtersMap = array(
        {% for column in builder.scopeColumns %}
            {{ column.name|as_php }} => {{ column.filterType|as_php }},
        {% endfor %}
        );

        $primaryKeysMap = array(
        {% for column in builder.scopeColumns %}
            {{ column.name|as_php }} => {{ column.primaryKey|as_php }},
        {% endfor %}
        );

        $queryFilter = $this->getQueryFilter();
        $queryFilter->setQuery($query);
        $queryFilter->setAliasPrefix('s_');
        $queryFilter->setNamePrefix('scopes_');
        $queryFilter->setFiltersMap($filtersMap);
        $queryFilter->setPrimaryKeysMap($primaryKeysMap);

        {% for groupName, group in scopes -%}
            {%- for scopeName, scopeParams in group %}

        if (isset($scopes['{{ groupName }}']) && $scopes['{{ groupName }}'] == '{{ scopeName }}') {
            {% if scopeParams["filters"] is defined -%}
                {%- for filter, filterParams in scopeParams["filters"] -%}
                {%- if filter|is_numeric -%}
                $this->scope{{ filterParams|classify }}($queryFilter);
                {%- else -%}
                $queryFilter->addEqualFilter('{{ filter }}', {{ filterParams|as_php }});
                {%- endif -%}
                {%- endfor -%}
            {%- endif %}

        }
            {% endfor -%}
        {%- endfor %}
    {%- endif %}
    }

    {% if scopes is defined %}
    {% for groupName, group in scopes -%}
        {%- for scopeName, scopeParams in group %}
            {% if scopeParams["filters"] is defined -%}
            {%- for filter, filterParams in scopeParams["filters"] -%}
                {%- if filter|is_numeric -%}
    /**
     * Add the filters to the query for {{ groupName }} => {{ scopeName }}
     *
     * @param $queryFilter The queryFilter.
     */
    protected function scope{{ filterParams|classify }}($queryFilter)
    {
    }

                {%- endif -%}
            {%- endfor -%}
            {%- endif -%}
        {% endfor -%}
    {%- endfor -%}
    {%- endif %}
{% endblock %}

{% block getQueryFilter %}
    /**
     * @return \Admingenerator\GeneratorBundle\QueryFilter\QueryFilterInterface
     */
    protected function getQueryFilter()
    {
        return $this->get('admingenerator.queryfilter.doctrine');
    }
{% endblock %}

{% block getSessionSerializer %}
    /**
     * @return \Admingenerator\GeneratorBundle\SessionSerializer\SessionSerializerInterface
     */
    protected function getSessionSerializer()
    {
        return $this->get('admingenerator.sessionserializer.doctrine');
    }
{% endblock %}
